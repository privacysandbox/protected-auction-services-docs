> FLEDGE has been renamed to Protected Audience API. To learn more about the name change, see the [blog post](https://privacysandbox.com/intl/en_us/news/protected-audience-api-our-new-name-for-fledge)

**Author:** <br>
[Priyanka Chatterjee][1], Google Privacy Sandbox

# Bidding and Auction services payload optimization

The [Bidding and Auction (B&A) services][2] outlines a strategy for allowing
Protected Auction auctions (Protected Audience, Protected App Signals[23]) to
take place in a [trusted execution environment][3] (TEE) on a [supported cloud
platform][4]. This document describes steps for optimizing the size of payload
uploaded from clients for Protected Audience.

As described in [Bidding and Auction (B&A) services high level architecture][21],
the seller's code in a publisher's webpage on browser or Android app sends a
unified contextual and Protected Auction HTTPS request (_unified request_)
to the seller's ad service. This request includes a contextual payload and
encrypted [`ProtectedAuctionInput`][5] data. (The contextual payload is not HPKE
encrypted; it may be TLS protected over the wire.) The seller's frontend service
orchestrates [`GetBids`][20] requests to buyers' BuyerFrontEnd services to
generate bids. The GetBids request payloads include BuyerInput and contextual
signals.

**Note**: 
* In case of Protected Audience, clients (web browser, app) prefetch
  `interest groups` (referred to as `custom audiences` for Android) periodically
  and stored on device.
* The [`ProtectedAuctionInput`][5] request payload is compressed, padded, and
  then encrypted by the client. The payload is decrypted and decompressed by the
  Bidding and Auction services.

This document provides guidance to adtechs for **optimizing size of Protected
Audience request payload** uploaded from web browser (on desktop, Android) for
B&A services. For Android app targeting, similar payload optimization strategies
and solutions can be followed.

**Payload optimization is a requirement for onboarding to B&A services.**

## Top reasons for payload optimization

The payload size optimization is important because:

* **[Latency & network cost]** Large payloads can be expensive to transmit;
  they impact overall auction **latency** and increase **network costs** for
  sellers and buyers. To mitigate these effects, the total size of compressed
  request payload uploaded from clients is recommended to be small (less than 60
  KB).

* **[Seller configured per-buyer limit]** A seller may impose a `per-buyer payload size limit`
  for [`ProtectedAuctionInput`][5] request payload.

* **[Utility]** In order to achieve good **utility** from Protected Audience
  auctions, enough `interest groups` must be included in `per-buyer payload size limit`
  and made available for bid generation.

## Higher payload driving factors

The following fields in [interest groups][6] required for [generateBid()][7] can
cause [`ProtectedAuctionInput`][5] payload sizes to become large, and hence can not
be included in the umbrella request payload uploaded by clients.

 * `ads` that include `renderUrl`(s) and `ad metadata`
    * _Note: There can be multiple ads per interest group_.
 * `adComponents`
    * _Note: There can be multiple ad components per ad in interest group_.
 * `userBiddingSignals`
    * _Note: There is no payload size limit on userBiddingSignals_.

*Note:*
 * The [`browserSignals`][27] generated by web browser, especially [`prevWins`][28]
   in the [`browserSignals`][27] can add to payload size overhead, however
   this is expected to be comparatively lower.

## Payload optimization strategies

Following are the high level strategies:

 * Only a small amount of information per `interest group` can be sent in the
   request payload for B&A. This would ensure that enough `interest groups` fit
   in a per-buyer payload limit.

 * For each `interest group` of a buyer, only the following information can be
   sent in the umbrella request payload.
   * `interest group` [name][24]
   * [trustedBiddingSignalKeys][25]
   * [browserSignals][26]

 * The buyer maintains an identifier (`adRenderId`) for each of its ads. Each ID
   is a short, **8-character or less bytestring** (12-byte or less when Base64 encoded)
   that identifies the ad. Buyer would generate short identifier for each `ad render url`
   and `component ad render url` such that `prevWins` size included in
   `browserSignals` is optimized. 
 
 * Per buyer input that include information about `interest groups` are
   **compressed** on the client.
 
 * For B&A auctions, `trustedBiddingSignals` is looked up from BuyerFrontEnd
   service. All other information in `interest group` required for generating
   bids in B&A, must be made available in `trustedBiddingSignals` fetched from
   buyer's Key/Value service.

## Payload optimization guide for sellers / SSPs

* We recommend to sellers to set `per-buyer payload size limit` in the 
  range of **2 KB to 4 KB** to ensure payload for enough buyers are included in
  [`ProtectedAuctionInput`][5]. 

* Sellers running B&A services, are required to incorporate [perBuyerConfig][33]
  to configure `per-buyer payload size limit`.

## Payload optimization guide for buyers / DSPs

### Steps for payload optimization
This section discusses solutions for optimizing per-buyer input included in
compressed [`ProtectedAuctionInput`][5] request payload.

#### Step 1

**The buyer creates `interest groups`**

It is recommended to buyers running B&A services to use a first party identifier (for example `first party user ID for
advertiser site or app`) for `trustedBiddingSignalKeys` and / or `interest group name`.
This would facilitate fetching data required by generateBid() for the
interest group in `trustedBiddingSignals` from buyer's key / value service. 

#### Step 2

**The buyer generates an identifier for each ad (`adRenderId`) to optimize size of ad `renderURL`.**

* Generate an `adRenderId`, that is an identifier for an `ad renderURL`. Similarly,
  also generate identifier for each `adComponent renderURL`.

##### Size of adRenderId & adComponentRenderId 

The ad render IDs and adComponent render IDs must be [DOMString][27] that are
**8 bytes** long or less. If the identifier string is Base64 encoded, it's length
must be **12 bytes** long or less.

#### Step 3

**The buyer sets priority for each `interest groups`**

Chrome allows buyers to set a priority value (floating point number) per [interest group][6].

* The buyer sets a priority for each [interest group][7] when interest groups are
  fetched by the client.

* The browser uses these priorities to select the higher priority interest groups and
  drop some lower-priority interest groups if per-buyer payload size limits are reached.

Higher priority `interest groups` is expected to provide better utility.

#### Step 4

**The buyer passes `adRenderId` to the browser during an interest group fetch and sets `auctionServerRequestFlags`.**

The buyer running B&A services, must pass the following additional information
in an [`interestGroup`][6] when browser fetch interest groups from the buyer's
tagging servers. 

* The buyer also populates the `adRenderId` field in each `ads` object in an `interest group`. 

* Sets the following two flags with specific enum, that would indicate to the browser to
  omit the ads, adComponents and userBiddingSignals data for this interest group from
  the `ProtectedAuctionInput` request payload. This is also noted in [Protected Audience API explainer][34].

  * The `omit-ads` enumeration causes the request to omit the `ads` and `adComponents` fields
    for this interest group from the auction blob.
  * The `omit-user-bidding-signals` enumeration causes the request to omit the
    `userBiddingSignals` field for this interest group from the auction blob.

  ```
   'auctionServerRequestFlags': ['omit-ads', 'omit-user-bidding-signals']
  ```

#### Step 5

**The browser sends small amount of information in each interest group, however
  includes adRenderIds in `prevWins` fields of `browserSignal` objects.**

The only information included in each interest group are the following. Note that the
browser will not include `adRenderId(s)` or `adComponentRenderId(s)` or `userBiddingSignals`
or any other information in interest groups. 
  * interest group `name`
  * `trustedBiddingSignalKeys`: It is recommended to be an identifier such as `first party user identifier per advertiser site (or app)`
  * [browserSignals][18]

##### Specification for browser signals

The specification for the browser signals for `generateBid()`, is illustrated in
the following example. 

```json
{ 'topWindowHostname': 'www.example-publisher.com',
  'seller': 'https://www.example-ssp.com',
  'topLevelSeller': 'https://www.another-ssp.com',
  'joinCount': 5,
  'bidCount': 24,
  'recency': 1684134092,
  'prevWins': [[time1, adRenderId1],[time2, adRenderId2],...],
  'wasmHelper': ... /* a WebAssembly.Module object based on interest group's biddingWasmHelperURL */
  'dataVersion': 1, /* Data-Version value from the trusted bidding signals server's response(s) if available */
}
```

The browser generates [browserSignals][18] per `interest group`, that includes
includes [joinCount][28], [bidCount][29], [recency][30] and [prevWins][31]; the
remaining fields in [browserSignals](#Specification-for-browser-signals) is populated
by Bidding service. 

The `prevWins` in `browserSignals` refers to a tuple of **time-adRenderId pairs**
for a previous win for this interest group that occurred in the last 30 days. Note that
`adRenderIds` are passed in `prevWins` instead of full ad objects. 

#### Step 6

**The buyer's `generateBid()` is able to handle adRenderIds, reporting Ids and generate render url for bids.**

* Bidding service passes `interest groups` to generateBid(), as received from
  the browser. This implies that these `interest groups` do not include `ads` or
  `adComponents` or `userBiddingSignals`. Buyer's generateBid() must be updated
  to handle such `interest groups`. Note that since `ads` object is omitted, ads
  attributes like `reporting Ids` are also omitted from `interest groups` object.

* `generateBid()` ingests adRenderIds in the `prevWins` field in the
  `browserSignals` object.

* The `trustedBiddingSignals` fetched from the buyer's Key Value Service
  include `adRenderID`, `ad metadata`, `reporting Ids` and `userBiddingSignals` information.

* `generateBid()` recreates the `ad render URLs`, `adComponent render URLs` and `reporting Ids`
  for the final bids after buyside auction.

   * `generateBid()` maintains a URL template with the base URL. The variable
      part of the render URL is recreated using information in the `interestGroup`
      and `trustedBiddingSignal` arguments.
     

#### Step 7

**Fetch userBiddingSignals per interest group from buyer's key / value service**

_This section can be skipped for buyers that don't depend on user bidding signals._

The browser will not include `userBiddingSignals` information in `interest group`s that
are sent in `ProtectedAuctionInput` request payload.

The `userBiddingSignals` information per `interest group` can be made available in
`trustedBiddingSignals`.


#### Step 8

**Mitigation for winning ad candidate validation**

For Protected Audience, the render URL and and reporting Ids associated with the winning ad candidate
returned from B&A services in encrypted response, is validated in browser to ensure that it
belongs to the interest group that the browser has information about. 

Since buyer's [generateBid()][7] generate render url for the bids based on the information
in `trustedBiddingSignals`, the URL may fail validation if the browser gets out of sync
with `interest group`s in buyer's key / value service. . Therefore, it is important
to incorporate the following mitigation.

**Mitigation:** Chrome browser launched more frequent `interest group` updates
triggered by `trustedBiddingSignals`, refer to [Intent-To-Ship][32] for more information.
With B&A, the `trustedBiddingSignals` are sent back to the BuyerFrontEnd service from
buyer's Key / Value service. B&A would indicate to the browser in encrypted AuctionResult
about how frequently or which interest groups require more frequent updates. 
Buyers must incorporate this feature to keep the browser in better sync with the
`interest group` information in buyer's key / value service. This will help mitigate
the render url validation failure issue.

## Related material

* [Bidding and Auction services][15]
* [Chrome client design for Bidding and Auction services integration](https://github.com/WICG/turtledove/blob/main/FLEDGE_browser_bidding_and_auction_API.md)
* [Android - Bidding and Auction services integration high level document](https://developer.android.com/design-for-safety/privacy-sandbox/protected-audience-bidding-and-auction-services)

[1]: https://github.com/chatterjee-priyanka
[2]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md
[3]: https://github.com/privacysandbox/fledge-docs/blob/main/trusted_services_overview.md#trusted-execution-environment
[4]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#supported-public-cloud-platforms
[5]: https://github.com/privacysandbox/bidding-auction-servers/blob/c98a51c7dc11de92e9c8fb719242a033e620a1b4/api/bidding_auction_servers.proto#L64
[6]: https://github.com/WICG/turtledove/blob/main/FLEDGE.md#12-interest-group-attributes
[7]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#generatebid
[12]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#buyerinput
[15]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md
[18]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#browersignals
[20]: https://github.com/privacysandbox/bidding-auction-servers/blob/c98a51c7dc11de92e9c8fb719242a033e620a1b4/api/bidding_auction_servers.proto#L638
[21]: https://github.com/privacysandbox/protected-auction-services-docs/blob/main/bidding_auction_services_api.md#high-level-design
[22]: https://github.com/WICG/turtledove/blob/main/FLEDGE.md#11-joining-interest-groups
[23]: https://github.com/privacysandbox/protected-auction-services-docs/blob/main/bidding_auction_services_protected_app_signals.md
[24]: https://github.com/privacysandbox/bidding-auction-servers/blob/e40a4fccdce168379189ab7b6b87b55b1e3f736d/api/bidding_auction_servers.proto#L119
[25]: https://github.com/privacysandbox/bidding-auction-servers/blob/e40a4fccdce168379189ab7b6b87b55b1e3f736d/api/bidding_auction_servers.proto#L123
[26]: https://github.com/privacysandbox/bidding-auction-servers/blob/e40a4fccdce168379189ab7b6b87b55b1e3f736d/api/bidding_auction_servers.proto#L161
[27]: https://webidl.spec.whatwg.org/#idl-DOMString
[28]: https://github.com/privacysandbox/bidding-auction-servers/blob/e40a4fccdce168379189ab7b6b87b55b1e3f736d/api/bidding_auction_servers.proto#L178
[29]: https://github.com/privacysandbox/bidding-auction-servers/blob/e40a4fccdce168379189ab7b6b87b55b1e3f736d/api/bidding_auction_servers.proto#L181
[30]: https://github.com/privacysandbox/bidding-auction-servers/blob/e40a4fccdce168379189ab7b6b87b55b1e3f736d/api/bidding_auction_servers.proto#L198
[31]: https://github.com/privacysandbox/bidding-auction-servers/blob/e40a4fccdce168379189ab7b6b87b55b1e3f736d/api/bidding_auction_servers.proto#L190
[32]: https://groups.google.com/a/chromium.org/g/blink-dev/c/eXJLbFAuSU8/m/WzCpcHaZAgAJ
[33]: https://github.com/WICG/turtledove/blob/main/FLEDGE_browser_bidding_and_auction_API.md#step-1-get-auction-blob-from-browser
[34]: https://github.com/WICG/turtledove/blob/main/FLEDGE.md#11-joining-interest-groups 
